<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<title>PiterJS - Results of code in the dark</title>
<style>
    body {

    }
    .results {
        max-width: 90%;
        margin: auto;
    }
    .results td {
        border: 1px solid #000;
        text-align: center;
    }
    .results thead td {
        text-align: center;
    }
    .results img {
        max-width: 100%;
    }
</style>
</head>

<body>

    <table class="results">
        <thead>
            <tr>
                <td>Имя</td>
                <td>Отклонение</td>
                <td>Результат</td>
                <td>Оригинал</td>
                <td>Разница</td>
            </tr>
        </thead>
        <tbody id="results"></tbody>
    </table>
<script>
const regexRes = /cid\/([\S]+)-([\S]+)-([\S]+)-([\S]+)\.diff\.png/
const regexDist = /cid\/([\S]+)-([\S]+)-([\S]{13})\.png/

function getResults() {
    var x = new XMLHttpRequest();
    x.open("GET", "/api/result", true);
    x.onload = function () {
        console.log(x.responseText);
        const plain = x.responseText
        const json = JSON.parse(plain)
        window.json = json
        window.res = json.filter((item) => regexRes.test(item.name))
        window.resDist = json.filter((item) => regexDist.test(item.name))
        buildTable(window.res)
    }
    x.send();
}

getResults()

function parseResults(res, regex) {
    const results = res.map((item, index) => {
        const resultName = item.name
        const parsed = regex.exec(resultName)

        return {
            name: parsed[1],
            template: parsed[2],
            itemName: item.name,
            diff: parsed[4],
        }
    })
    return results
}

function sortResults(results) {
    return results.sort(function(prev, next) {
        return Number(next.diff) - Number(prev.diff)
    })
}

function buildTable(res) {
    const $results = document.querySelector('#results')
    const results = sortResults(parseResults(window.res, regexRes))
    const resultsDist = sortResults(parseResults(window.resDist, regexDist))

    $results.innerHTML = results.map((item, index) =>
        `<tr>
            <td>${item.name}</td>
            <td>${item.diff}</td>
            <td><img src="/api/get/${resultsDist[index].itemName}" alt="" /></td>
            <td><img src="/api/get/cid/${item.template}.png" alt="" /></td>
            <td><img src="/api/get/${results[index].itemName}" alt="" /></td>
        </tr>`
    ).join(' ')
}

function ready() {
    getResults()
}
document.addEventListener("DOMContentLoaded", ready);
</script>
</body>

</html>